# üöÄ Job Queue Setup - LoveMemory Intelligence Core

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ç—è–∂–µ–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É—è API –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
[API Server] ‚Üí [Redis Queue] ‚Üí [Worker Process] ‚Üí [Database]
     ‚Üì              ‚Üì              ‚Üì
  –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π    –ù–∞–¥—ë–∂–Ω–æ–µ        –§–æ–Ω–æ–≤—ã–π
   –æ—Ç–≤–µ—Ç       —Ö—Ä–∞–Ω–µ–Ω–∏–µ        –∞–Ω–∞–ª–∏–∑
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **Redis Server** - –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–µ–π –∑–∞–¥–∞—á
2. **Node.js** - –¥–ª—è —Ä–∞–±–æ—Ç—ã API –∏ –≤–æ—Ä–∫–µ—Ä–æ–≤
3. **PostgreSQL** - –æ—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Redis

### Windows (—á–µ—Ä–µ–∑ chocolatey)
```bash
choco install redis-64
redis-server
```

### macOS (—á–µ—Ä–µ–∑ homebrew)
```bash
brew install redis
brew services start redis
```

### Linux (Ubuntu/Debian)
```bash
sudo apt update
sudo apt install redis-server
sudo systemctl start redis
```

### Docker (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ)
```bash
docker run -d --name redis -p 6379:6379 redis:alpine
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ –≤–∞—à `.env` —Ñ–∞–π–ª:

```env
# Redis Configuration
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=          # –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
REDIS_DB=0
```

## –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

### 1. –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ API —Å–µ—Ä–≤–µ—Ä–∞
```bash
cd server
npm run dev
```

### 2. –ó–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
```bash
cd server
npm run worker
```

–ò–ª–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π:
```bash
npm run worker:dev
```

## API Endpoints

### –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
```bash
GET /api/queue/health
GET /api/queue/status
```

### –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á
```bash
# –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
POST /api/queue/analysis
{
  "priority": 10,
  "delay": 0
}

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Å–∞–π—Ç–æ–≤
POST /api/queue/insight
{
  "eventId": "uuid",
  "priority": 20,
  "delay": 5000
}
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—è–º–∏
```bash
# –ü–∞—É–∑–∞/–≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
POST /api/queue/manage
{
  "queueName": "analysis",
  "action": "pause"
}

# –û—á–∏—Å—Ç–∫–∞ (—Ç–æ–ª—å–∫–æ –≤ development)
DELETE /api/queue/clear-all
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏:

1. **–°–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–±—ã—Ç–∏—è** ‚Üí –ê–Ω–∞–ª–∏–∑ + –ò–Ω—Å–∞–π—Ç—ã (10-15 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∞)
2. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** ‚Üí –ü–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (30 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∞)
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è** ‚Üí –ü–µ—Ä–µ–∞–Ω–∞–ª–∏–∑ (60 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∞)

## –¢–∏–ø—ã –∑–∞–¥–∞—á

### 1. Analysis Queue (`analysis`)
- **–ó–∞–¥–∞—á–∞**: –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: 5-15 —Å–µ–∫—É–Ω–¥
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: 10-30 (–º–µ–Ω—å—à–µ = –≤—ã—à–µ)
- **–ü–æ–≤—Ç–æ—Ä—ã**: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

### 2. Insights Queue (`insights`)  
- **–ó–∞–¥–∞—á–∞**: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Å–∞–π—Ç–æ–≤ –ø–æ —Å–æ–±—ã—Ç–∏—è–º
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: 3-8 —Å–µ–∫—É–Ω–¥
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: 20-25
- **–ü–æ–≤—Ç–æ—Ä—ã**: 3 –ø–æ–ø—ã—Ç–∫–∏

### 3. Maintenance Queue (`maintenance`)
- **–ó–∞–¥–∞—á–∞**: –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: 1-30 —Å–µ–∫—É–Ω–¥
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: 30+ (–Ω–∏–∑–∫–∏–π)
- **–ü–æ–≤—Ç–æ—Ä—ã**: 2 –ø–æ–ø—ã—Ç–∫–∏

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–∞
```bash
npm run worker
# üìä Processing analysis job for user abc-123
# ‚úÖ Analysis completed for user abc-123
# üí° Processing insight job for user abc-123, event def-456
```

### Web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Bull Dashboard:
```bash
npm install bull-board
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
```bash
curl http://localhost:5000/api/queue/health
```

–û—Ç–≤–µ—Ç:
```json
{
  "success": true,
  "data": {
    "overall": "healthy",
    "redis": "connected",
    "queues": {
      "status": "healthy",
      "queues": ["analysis", "insights", "maintenance"]
    }
  }
}
```

## –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è —Å—Ä–µ–¥–∞

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –ó–∞–ø—É—Å–∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤
npm run worker &  # –í–æ—Ä–∫–µ—Ä 1
npm run worker &  # –í–æ—Ä–∫–µ—Ä 2
npm run worker &  # –í–æ—Ä–∫–µ—Ä 3
```

### Process Manager (PM2)
```bash
npm install -g pm2

# API —Å–µ—Ä–≤–µ—Ä
pm2 start index.js --name "lovememory-api"

# –í–æ—Ä–∫–µ—Ä—ã
pm2 start worker.js --name "lovememory-worker-1"
pm2 start worker.js --name "lovememory-worker-2"

# –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
pm2 startup
pm2 save
```

### Redis –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Redis Cluster –¥–ª—è –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (AOF + RDB)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ Redis Sentinel
- –ë—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π

## Troubleshooting

### Redis –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis
redis-cli ping
# –û—Ç–≤–µ—Ç: PONG

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
netstat -an | grep 6379

# –õ–æ–≥–∏ Redis
tail -f /var/log/redis/redis-server.log
```

### –í–æ—Ä–∫–µ—Ä –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Redis
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –æ—á–µ—Ä–µ–¥–∏ –Ω–µ –Ω–∞ –ø–∞—É–∑–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–æ—Ä–∫–µ—Ä

### –ó–∞–¥–∞—á–∏ –∑–∞—Å—Ç—Ä–µ–≤–∞—é—Ç
```bash
# –û—á–∏—Å—Ç–∫–∞ –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö –∑–∞–¥–∞—á
curl -X DELETE http://localhost:5000/api/queue/clear-all
```

### Performance Tips
- –£–≤–µ–ª–∏—á—å—Ç–µ `concurrency` –≤ –≤–æ—Ä–∫–µ—Ä–∞—Ö –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `removeOnComplete` –∏ `removeOnFail` –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `priority` –¥–ª—è –≤–∞–∂–Ω—ã—Ö –∑–∞–¥–∞—á
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ Redis

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã

‚úÖ **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã** - API –Ω–µ –∂–¥—ë—Ç –∞–Ω–∞–ª–∏–∑–∞  
‚úÖ **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** - –∑–∞–¥–∞—á–∏ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ —Å–±–æ—è—Ö  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–æ—Ä–∫–µ—Ä–æ–≤  
‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –ø–æ–ª–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤  
‚úÖ **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è** - –≤–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏  

üéØ **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã, –∞ —Ç—è–∂—ë–ª—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ñ–æ–Ω–µ!



