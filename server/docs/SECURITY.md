# Безопасность LoveMemory API

## Обзор мер безопасности

### 1. Аутентификация и авторизация

- **JWT токены** с истечением срока действия (24 часа)
- **bcrypt** для хеширования паролей (salt rounds: 10)
- **Rate limiting** для попыток входа (5 попыток за 15 минут)
- **UUID** для идентификаторов пользователей

### 2. Валидация входных данных

- **express-validator** для валидации всех пользовательских входов
- **Санитизация** HTML контента
- **Белые списки** для допустимых значений (типы игр, пол, и т.д.)
- **Ограничения длины** для всех текстовых полей

### 3. Загрузка файлов

- **Белый список MIME типов**: только изображения (JPEG, PNG, GIF, WebP)
- **Проверка расширений файлов**
- **Ограничение размера**: максимум 10 МБ
- **Очистка имен файлов** от опасных символов
- **Rate limiting**: 10 загрузок в час

### 4. Заголовки безопасности

```javascript
// Автоматически устанавливаемые заголовки:
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Content-Security-Policy: строгая политика
Strict-Transport-Security: включен в production
Referrer-Policy: same-origin
```

### 5. Rate Limiting

| Endpoint | Лимит | Окно |
|----------|-------|------|
| Общие API | 1000 запросов | 15 минут |
| Аутентификация | 5 попыток | 15 минут |
| Загрузка файлов | 10 загрузок | 1 час |
| AI запросы | 50 запросов | 1 час |

### 6. CORS (Cross-Origin Resource Sharing)

- **Белый список доменов** через переменную окружения `ALLOWED_ORIGINS`
- **Автоматическое разрешение** localhost в development
- **Проверка Origin** заголовка для дополнительной безопасности

### 7. Защита базы данных

- **Sequelize ORM** - автоматическая защита от SQL injection
- **Параметризованные запросы**
- **Валидация на уровне моделей**
- **Индексы** для оптимизации производительности

### 8. WebSocket безопасность

- **Аутентификация** через JWT токены
- **Валидация** всех входящих сообщений
- **Rate limiting** на уровне сокетов
- **Проверка прав доступа** к игровым комнатам

## Переменные окружения

### Обязательные для безопасности:

```env
# JWT секрет (минимум 32 символа)
JWT_SECRET=your-super-secret-jwt-key-here

# Секрет сессии
SESSION_SECRET=your-session-secret-here

# Разрешенные домены (через запятую)
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com

# URL клиентского приложения
CLIENT_URL=https://yourdomain.com

# AI Gateway URL (если используется)
AI_GATEWAY_URL=https://your-ai-gateway.com
```

### Рекомендуемые для production:

```env
# Режим окружения
NODE_ENV=production

# База данных (используйте SSL)
DATABASE_URL=postgresql://user:pass@host:port/db?ssl=true

# Дополнительные настройки безопасности
SECURE_COOKIES=true
TRUST_PROXY=true
```

## Рекомендации по развертыванию

### 1. HTTPS

- **Обязательно** используйте HTTPS в production
- Настройте **автоматическое перенаправление** с HTTP на HTTPS
- Используйте **современные TLS сертификаты**

### 2. Прокси и Load Balancer

```javascript
// Если используете прокси (nginx, cloudflare, etc.)
app.set('trust proxy', true);
```

### 3. Мониторинг безопасности

- Логируйте **подозрительную активность**
- Мониторьте **превышения rate limits**
- Отслеживайте **неудачные попытки аутентификации**

### 4. Регулярные обновления

- Обновляйте **зависимости** регулярно
- Проверяйте **уязвимости** с помощью `npm audit`
- Используйте **Dependabot** или аналогичные инструменты

## Аудит безопасности

### Команды для проверки:

```bash
# Проверка уязвимостей в зависимостях
npm audit

# Автоматическое исправление
npm audit fix

# Проверка outdated пакетов
npm outdated
```

### Инструменты для тестирования:

- **OWASP ZAP** - для тестирования веб-приложений
- **Burp Suite** - для manual security testing
- **SQLMap** - для проверки SQL injection (не должно найти уязвимостей)

## Отчетность об уязвимостях

Если вы обнаружили уязвимость безопасности:

1. **НЕ создавайте публичный issue**
2. Отправьте описание на security@yourdomain.com
3. Включите **подробное описание** и **шаги воспроизведения**
4. Дождитесь подтверждения получения

## Контрольный список безопасности

- [ ] JWT_SECRET установлен и достаточно сложен
- [ ] HTTPS настроен в production
- [ ] CORS правильно сконфигурирован
- [ ] Rate limiting включен
- [ ] Валидация входных данных работает
- [ ] Заголовки безопасности установлены
- [ ] Логирование безопасности настроено
- [ ] База данных использует SSL
- [ ] Регулярные бэкапы настроены
- [ ] Мониторинг ошибок работает

---

*Последнее обновление: январь 2025*
